<!doctype html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Uittamon uusi Puisto ğŸ°ğŸŒˆ</title>
  <style>
    :root {
      --bg1: #e7f7ff;
      --bg2: #ffe8f5;
      --panel: rgba(255, 255, 255, 0.86);
      --line: #ffd3ea;
      --text: #4c3b69;
      --good: #43c98e;
      --accent: #8a7bff;
      --card: #fff8ff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Baloo 2", "Comic Sans MS", "Trebuchet MS", sans-serif;
      color: var(--text);
      background: linear-gradient(160deg, var(--bg1), var(--bg2));
    }
    .topbar {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #ffffffd9;
      backdrop-filter: blur(6px);
      border-bottom: 3px solid var(--line);
      display: grid;
      grid-template-columns: repeat(5, minmax(120px, 1fr));
      gap: 8px;
      padding: 8px;
    }
    .res {
      border: 2px solid var(--line);
      border-radius: 16px;
      padding: 8px;
      background: #fff;
      box-shadow: 0 4px 0 #ffeff8;
      font-size: 14px;
    }
    .layout {
      max-width: 1800px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 340px 1fr 330px;
      gap: 12px;
      padding: 12px;
    }
    .panel {
      background: var(--panel);
      border-radius: 18px;
      border: 2px solid var(--line);
      padding: 10px;
    }
    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }
    button, select {
      border: 0;
      background: #fff;
      border-radius: 12px;
      padding: 8px 10px;
      color: var(--text);
      font-weight: 700;
      box-shadow: 0 3px 0 #e8ddff;
      cursor: pointer;
    }
    button:hover { transform: translateY(-1px); }
    button.active { background: #f7f2ff; outline: 2px solid var(--accent); }
    .cards { max-height: 77vh; overflow: auto; display: flex; flex-direction: column; gap: 8px; }
    .card {
      background: var(--card);
      border: 2px solid #f2d9ff;
      border-radius: 14px;
      padding: 8px;
      font-size: 13px;
    }
    .modules { font-size: 20px; letter-spacing: 2px; }
    .small { color: #8769a8; font-size: 12px; }
    .row { display: flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap; }
    .canvasWrap { position: relative; }
    canvas {
      width: 100%;
      height: 76vh;
      border-radius: 22px;
      border: 3px solid #d8c8ff;
      background: linear-gradient(#9de4ff 0 58%, #c9ffa9 58% 100%);
    }
    #hint, #toast {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 16px;
      border-radius: 999px;
      background: #ffffffdb;
      border: 2px solid #ffd0e6;
      font-weight: 700;
      transition: opacity .3s;
      pointer-events: none;
      opacity: 0;
      text-align: center;
    }
    #hint { top: 8px; opacity: 1; }
    #toast { top: 48px; }
    .bar {
      height: 16px;
      border-radius: 999px;
      background: #ede1ff;
      overflow: hidden;
      border: 1px solid #d5b9ff;
      margin-top: 2px;
    }
    .fill {
      height: 100%;
      background: linear-gradient(90deg, #7cffdb, #7a9bff, #ff92dd);
      transition: width .35s;
    }
    .quest {
      border-radius: 12px;
      background: #fef6ff;
      border: 2px dashed #e2b3ff;
      padding: 8px;
      margin-bottom: 8px;
      font-size: 13px;
    }
    .shopItem {
      border: 2px solid #ffd8ef;
      border-radius: 12px;
      background: #fff;
      padding: 8px;
      margin-bottom: 7px;
      font-size: 13px;
    }
    @media (max-width: 1380px) {
      .layout { grid-template-columns: 1fr; }
      .cards { max-height: none; }
      canvas { height: 54vh; }
    }
  </style>
</head>
<body>
  <div class="topbar" id="topbar"></div>

  <div class="layout">
    <aside class="panel">
      <h3>ğŸ§± Rakennusvalikko</h3>
      <div class="small">Klikkaa rakennusta lisÃ¤tÃ¤ksesi sen puistoon! â€¢ Palikat: ğŸ“ğŸâ­</div>
      <div class="tabs" id="tabs"></div>
      <div class="row" style="margin:8px 0;">
        <input id="search" placeholder="Etsi nimeÃ¤" style="flex:1;border-radius:10px;border:2px solid #efdcff;padding:8px;" />
        <select id="tier"><option value="all">Kaikki</option><option value="1">Tier 1</option><option value="2">Tier 2</option><option value="3">Tier 3</option></select>
      </div>
      <div class="cards" id="cards"></div>
    </aside>

    <main class="panel">
      <div class="canvasWrap">
        <canvas id="game" width="1000" height="650"></canvas>
        <div id="hint">NÃ¤etkÃ¶ kuinka monta marjaa saat sekunnissa? ğŸŒŸ</div>
        <div id="toast"></div>
      </div>
      <div class="row" style="margin-top:8px;">
        <div>ğŸ‘‰ TÃ¤hdet loistavat kirkkaasti! Rakennukset kasvavat tasoilla +1 / +5.</div>
        <div>
          <button id="soundBtn">ğŸ”Š Ã„Ã¤net: ON</button>
          <button id="saveBtn">ğŸ’¾ Tallenna</button>
          <button id="loadBtn">ğŸ“‚ Lataa</button>
          <button id="resetBtn">ğŸ§¼ Alusta</button>
        </div>
      </div>
    </main>

    <aside class="panel">
      <h3>ğŸ“Š Live Stats</h3>
      <div id="stats"></div>
      <h3>ğŸ˜Š PÃ¤ivÃ¤tehtÃ¤vÃ¤t</h3>
      <div id="quests"></div>
      <h3>ğŸ Bonus-kauppa</h3>
      <div id="shop"></div>
    </aside>
  </div>

  <script>
    const rng = (seed => () => (seed = (seed * 1664525 + 1013904223) >>> 0) / 4294967296)(202406);
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    const categories = ['Puutarha', 'Hauskat', 'Taika', 'TehtÃ¤vÃ¤t'];
    const emojis = ['ğŸ“', 'âœ¨', 'ğŸŒ¼', 'ğŸ', 'ğŸ’¡', 'ğŸŒ', 'ğŸ’¦', 'ğŸˆ', 'â­'];
    const baseNames = {
      Puutarha: ['Aurinkopuutarha', 'HattaraPurkki', 'Marjapelto', 'VesilÃ¤hde', 'Kukkapolku', 'PupuMetsÃ¤', 'SammalSaari', 'LempiLehto', 'SÃ¶pÃ¶Siemen', 'PilkePiha'],
      Hauskat: ['Keinu', 'LiukumÃ¤ki', 'Pomppulinna', 'Vesisuihku', 'Pupurata', 'HymyLava', 'Pallopuu', 'NauruNurkka', 'LeikkiKatos', 'RiemuSilta'],
      Taika: ['TÃ¤htiSalama', 'Auringonkakku', 'PilviPalatsi', 'SateenkaariTalo', 'KimallusTorni', 'YksisarviPortti', 'KuuKello', 'TaikaLÃ¤hde', 'OnniObeliski', 'UnelmaPuu']
    };

    function generateHappyBuildings(seed) {
      let s = seed >>> 0;
      const r = () => (s = (s * 1103515245 + 12345) >>> 0) / 4294967296;
      const all = [];
      const groups = ['Puutarha', 'Hauskat', 'Taika'];
      const effects = [
        { k: 'berries', txt: 'LisÃ¤Ã¤ ğŸ“' },
        { k: 'flowers', txt: 'LisÃ¤Ã¤ ğŸŒ¼' },
        { k: 'light', txt: 'LisÃ¤Ã¤ ğŸ’¡' },
        { k: 'stars', txt: 'LisÃ¤Ã¤ âœ¨' },
        { k: 'fruits', txt: 'LisÃ¤Ã¤ ğŸ' },
      ];

      groups.forEach(group => {
        for (let i = 0; i < 30; i++) {
          const tier = i < 10 ? 1 : i < 20 ? 2 : 3;
          const nameRoot = baseNames[group][i % baseNames[group].length];
          const effectA = effects[(i + Math.floor(r() * 3)) % effects.length];
          const effectB = effects[(i + 2 + Math.floor(r() * 2)) % effects.length];
          const prod = { berries: 0, flowers: 0, light: 0, stars: 0, fruits: 0 };
          prod[effectA.k] += +(0.3 * tier + r() * tier).toFixed(2);
          prod[effectB.k] += +(0.15 * tier + r() * 0.7).toFixed(2);
          const modulePool = ['ğŸ“ˆ', 'ğŸŒ', 'ğŸ’¦', 'ğŸˆ', 'â­', 'ğŸ“', 'ğŸŒ¼', 'ğŸ’¡', 'ğŸ'];
          const modules = [modulePool[(i + 1) % modulePool.length], modulePool[(i + 3) % modulePool.length], modulePool[(i + 7) % modulePool.length]];

          all.push({
            id: `${group.toLowerCase()}-${i}`,
            name: `${nameRoot} ${i + 1}`,
            category: group,
            icon: group === 'Puutarha' ? 'ğŸŸ¢' : group === 'Hauskat' ? 'ğŸ”µ' : 'ğŸŸ¡',
            tier,
            cost: {
              stars: Math.floor((6 + i * 2.6) * tier),
              berries: Math.floor((16 + i * 7.4) * tier)
            },
            produce: prod,
            modules,
            visualImpact: {
              size: 0.9 + tier * 0.25,
              sparkle: tier,
              bounce: 0.5 + r()
            },
            what: `${effectA.txt} +${prod[effectA.k]}/s, ${effectB.txt} +${prod[effectB.k]}/s`
          });
        }
      });
      return all;
    }

    const buildings = generateHappyBuildings(7777);
    const state = {
      tab: 'Puutarha',
      resources: { berries: 125, stars: 34, flowers: 88, fruits: 42, light: 57 },
      rates: { berries: 0, stars: 0, flowers: 0, fruits: 0, light: 0 },
      built: {},
      decorations: [],
      particles: [],
      bunnies: [{x:130,y:485,v:25},{x:240,y:500,v:20},{x:860,y:498,v:-23}],
      butterflies: [{x:200,y:220,s:0.8},{x:700,y:190,s:1.2}],
      clouds: [{x:90,y:110},{x:380,y:80},{x:760,y:125}],
      questsDone: {},
      rainbowTimer: 0,
      soundOn: true,
      unicornFlash: 0,
      bonus: { rainbow: 0, balloons: 0, flower: 0, melody: 0 }
    };

    const topbar = document.getElementById('topbar');
    const tabs = document.getElementById('tabs');
    const cards = document.getElementById('cards');
    const stats = document.getElementById('stats');
    const questsEl = document.getElementById('quests');
    const shop = document.getElementById('shop');
    const toast = document.getElementById('toast');

    let audioCtx = null;
    function playTone(type = 'pop', f = 430, len = 0.12) {
      if (!state.soundOn) return;
      audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type === 'bg' ? 'sine' : 'triangle';
      o.frequency.value = f;
      g.gain.value = type === 'bg' ? 0.018 : 0.06;
      o.connect(g);
      g.connect(audioCtx.destination);
      o.start();
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + len);
      o.stop(audioCtx.currentTime + len);
    }

    setInterval(() => {
      if (!state.soundOn) return;
      if (rng() > 0.72) playTone('bg', 260 + rng() * 120, 0.38);
    }, 850);

    function fmt(n) { return n.toFixed(n > 100 ? 0 : 1); }

    function showToast(msg) {
      toast.textContent = msg;
      toast.style.opacity = 1;
      clearTimeout(showToast.t);
      showToast.t = setTimeout(() => (toast.style.opacity = 0), 1300);
    }

    function addConfetti(x, y, n = 16, kind = 'confetti') {
      for (let i = 0; i < n; i++) {
        state.particles.push({ x, y, vx: (rng() - 0.5) * 160, vy: -rng() * 180, t: 1 + rng(), kind });
      }
    }

    function calcRates() {
      const rates = { berries: 0, stars: 0, flowers: 0, fruits: 0, light: 0 };
      buildings.forEach(b => {
        const own = state.built[b.id];
        if (!own) return;
        const mult = own.count * (1 + own.level * 0.18) * (1 + state.bonus.flower * 0.1);
        rates.berries += b.produce.berries * mult;
        rates.stars += b.produce.stars * mult;
        rates.flowers += b.produce.flowers * mult;
        rates.fruits += b.produce.fruits * mult;
        rates.light += b.produce.light * mult;
      });
      if (state.bonus.rainbow > 0) rates.stars *= 1 + state.bonus.rainbow * 0.08;
      state.rates = rates;
    }

    function buy(id, amount = 1) {
      const b = buildings.find(x => x.id === id);
      if (!b) return;
      let totalStar = 0;
      let totalBerry = 0;
      const own = state.built[id] || (state.built[id] = { count: 0, level: 1 });
      for (let i = 0; i < amount; i++) {
        const scale = Math.pow(1.13, own.count + i);
        totalStar += b.cost.stars * scale;
        totalBerry += b.cost.berries * scale;
      }
      if (state.resources.stars < totalStar || state.resources.berries < totalBerry) {
        showToast('Tarvitaan lisÃ¤Ã¤ âœ¨ tai ğŸ“');
        return;
      }
      state.resources.stars -= totalStar;
      state.resources.berries -= totalBerry;
      own.count += amount;
      state.decorations.push({ id, x: 100 + rng() * 800, y: 360 + rng() * 230, wobble: rng() * 100, color: `hsl(${90 + rng()*220},90%,70%)` });
      addConfetti(500, 300, 20, 'confetti');
      playTone('pop', 360 + rng() * 100, 0.08);
      showToast('Pop! Rakennus valmis ğŸ‰');
      calcRates();
      render();
    }

    function upgrade(id, amount) {
      const own = state.built[id];
      if (!own) return;
      const cost = 18 * amount * own.level;
      if (state.resources.stars < cost) return showToast('Tarvitaan enemmÃ¤n tÃ¤htiÃ¤ â­');
      state.resources.stars -= cost;
      own.level += amount;
      addConfetti(530, 280, 10, 'spark');
      playTone('pop', 510, 0.1);
      render();
    }

    const questDefs = [
      { id: 'q1', txt: 'KerÃ¤Ã¤ ğŸ“ 100', ok: s => s.resources.berries >= 100, reward: () => { state.resources.stars += 5; } },
      { id: 'q2', txt: 'Jos valo alle 20, auta aurinkopuutarhaa', ok: s => s.resources.light < 20, optional: true, reward: () => { state.resources.light += 24; } },
      { id: 'q3', txt: 'Tee 3 Hauskat-rakennusta', ok: s => buildings.filter(b => b.category === 'Hauskat').reduce((a,b)=>a+((s.built[b.id]?.count)||0),0) >= 3, reward: () => { state.resources.fruits += 20; } },
      { id: 'q4', txt: 'Sateenkaari nÃ¤kyy â†’ seuraava bonus', ok: s => s.rainbowTimer > 0, reward: () => { state.resources.stars += 12; state.bonus.balloons += 1; } }
    ];

    function claimQuest(id) {
      const q = questDefs.find(x => x.id === id);
      if (!q || state.questsDone[id]) return;
      if (!q.ok(state)) return;
      state.questsDone[id] = true;
      q.reward();
      addConfetti(500, 220, 40, 'balloon');
      showToast('ğŸˆ TehtÃ¤vÃ¤ valmis! Hyvin tehty!');
      playTone('pop', 660, 0.2);
      render();
    }

    const bonusShop = [
      { id: 'rainbow', name: 'ğŸ’« Extra-sateenkaari', cost: { stars: 40, berries: 120 }, txt: 'Kertaa visuaalit, lisÃ¤Ã¤ tÃ¤htituottoa hieman.' },
      { id: 'balloons', name: 'ğŸˆ Ilmapallopomppi', cost: { stars: 18, berries: 80 }, txt: 'LisÃ¤Ã¤ ilmapalloja ja pomppuiloa.' },
      { id: 'flower', name: 'ğŸŒ» Kukka-bonari', cost: { stars: 30, berries: 140 }, txt: '+10% tuotantoa iloisesti.' },
      { id: 'melody', name: 'ğŸµ Laulu-piste', cost: { stars: 22, berries: 70 }, txt: 'PieniÃ¤ lisÃ¤-Ã¤Ã¤niefektejÃ¤.' },
    ];

    function buyBonus(id) {
      const b = bonusShop.find(x => x.id === id);
      if (!b) return;
      if (state.resources.stars < b.cost.stars || state.resources.berries < b.cost.berries) return showToast('Ei vielÃ¤ tarpeeksi resursseja');
      state.resources.stars -= b.cost.stars;
      state.resources.berries -= b.cost.berries;
      state.bonus[id] += 1;
      if (id === 'rainbow') state.rainbowTimer = 16;
      if (id === 'melody') playTone('pop', 740, 0.22);
      showToast('Bonus avattu! ğŸŒˆ');
      addConfetti(460, 250, 26, 'spark');
      calcRates();
      render();
    }

    function drawPark(dt) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = '#ffec8f';
      ctx.beginPath();
      ctx.arc(120, 90, 45, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = '#8a5e2d';
      ctx.fillRect(95, 130, 50, 10);
      ctx.fillStyle = '#5d4e85';
      ctx.font = '18px sans-serif';
      ctx.fillText('ğŸ˜Š', 107, 100);

      state.clouds.forEach(c => {
        c.x += dt * 16;
        if (c.x > canvas.width + 80) c.x = -120;
        ctx.fillStyle = '#ffffffdd';
        ctx.beginPath();
        ctx.ellipse(c.x, c.y, 50, 24, 0, 0, Math.PI * 2);
        ctx.fill();
      });

      if (state.unicornFlash > 0 || rng() > 0.995) {
        state.unicornFlash = 1.8;
      }
      if (state.unicornFlash > 0) {
        state.unicornFlash -= dt;
        ctx.font = '42px sans-serif';
        ctx.fillText('ğŸ¦„', 760 + Math.sin(performance.now() / 190) * 70, 150);
      }

      if (state.rainbowTimer > 0) {
        state.rainbowTimer -= dt;
        for (let i = 0; i < 7; i++) {
          ctx.strokeStyle = ['#ff86b6','#ffa067','#ffe26b','#96ef7f','#7bddff','#8192ff','#e693ff'][i];
          ctx.lineWidth = 6;
          ctx.beginPath();
          ctx.arc(canvas.width / 2, 390, 170 + i * 10 + state.bonus.rainbow * 5, Math.PI, Math.PI * 2);
          ctx.stroke();
        }
      }

      // Central tree
      ctx.fillStyle = '#8d5931';
      ctx.fillRect(462, 270, 76, 210);
      const pulse = 1 + Math.sin(performance.now() / 350) * 0.04;
      ctx.save();
      ctx.translate(500, 220);
      ctx.scale(pulse, pulse);
      ctx.fillStyle = '#76df79';
      ctx.beginPath();
      ctx.arc(0, 0, 130, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();

      state.decorations.forEach((d, i) => {
        const own = state.built[d.id];
        if (!own) return;
        const b = buildings.find(x => x.id === d.id);
        const s = b.visualImpact.size + own.level * 0.1;
        const bob = Math.sin((performance.now() / 240) + d.wobble) * 4 * b.visualImpact.bounce;

        ctx.save();
        ctx.translate(d.x, d.y + bob);
        ctx.scale(s * 0.55, s * 0.55);
        ctx.fillStyle = d.color;
        ctx.fillRect(-25, -35, 50, 70);
        ctx.fillStyle = '#fff';
        ctx.font = '28px sans-serif';
        ctx.fillText(b.icon, -16, -8);
        ctx.font = '30px sans-serif';
        ctx.fillText(b.modules[0], -17, 20);
        ctx.restore();

        if (rng() > 0.992) state.particles.push({ x: d.x, y: d.y - 20, vx: (rng() - .5) * 35, vy: -35, t: 1.2, kind: 'heart' });
        if (i % 2 === 0 && rng() > 0.994) state.particles.push({ x: d.x, y: d.y - 18, vx: (rng() - .5) * 18, vy: -42, t: 1, kind: 'spark' });
      });

      state.bunnies.forEach(b => {
        b.x += b.v * dt;
        if (b.x < 20 || b.x > canvas.width - 20) b.v *= -1;
        const jump = Math.abs(Math.sin(performance.now() / 190 + b.x * 0.04)) * 10;
        ctx.font = '34px sans-serif';
        ctx.fillText('ğŸ°', b.x, b.y - jump);
      });

      state.butterflies.forEach(b => {
        b.x += dt * 35 * b.s;
        if (b.x > canvas.width + 20) b.x = -20;
        const y = b.s * 110 + 140 + Math.sin(performance.now() / 220 + b.x * 0.04) * 20;
        ctx.font = '23px sans-serif';
        ctx.fillText('ğŸ¦‹', b.x, y);
      });

      for (let i = state.particles.length - 1; i >= 0; i--) {
        const p = state.particles[i];
        p.x += p.vx * dt;
        p.y += p.vy * dt;
        p.vy += 130 * dt;
        p.t -= dt;
        if (p.t <= 0) { state.particles.splice(i, 1); continue; }
        const map = { confetti: 'ğŸ‰', balloon: 'ğŸˆ', heart: 'ğŸ’–', spark: 'âœ¨' };
        ctx.globalAlpha = Math.max(0, p.t);
        ctx.font = p.kind === 'confetti' ? '20px sans-serif' : '24px sans-serif';
        ctx.fillText(map[p.kind] || 'âœ¨', p.x, p.y);
        ctx.globalAlpha = 1;
      }

      if (rng() > 0.996) {
        state.particles.push({ x: rng() * canvas.width, y: 320 + rng() * 250, vx: (rng() - 0.5) * 12, vy: -40, t: 1.4, kind: 'heart' });
      }
    }

    function update(dt) {
      calcRates();
      Object.keys(state.resources).forEach(k => {
        state.resources[k] += state.rates[k] * dt;
      });
      if (state.resources.light < 20 && rng() > 0.99) showToast('Valo on matala, auta aurinkopuutarhaa! â˜€ï¸');
      if (rng() > 0.997) {
        state.rainbowTimer = 10 + state.bonus.rainbow * 3;
        showToast('Sateenkaari! Seuraava bonus odottaa ğŸŒˆ');
        playTone('pop', 590, 0.12);
      }
      if (state.bonus.balloons > 0 && rng() > 0.98) {
        addConfetti(100 + rng() * 800, 540, 2 + state.bonus.balloons, 'balloon');
      }
    }

    function renderTop() {
      const data = [
        ['ğŸ“ Marjat', 'berries'], ['âœ¨ TÃ¤hdet', 'stars'], ['ğŸŒ¼ Kukat', 'flowers'], ['ğŸ HedelmÃ¤t', 'fruits'], ['ğŸ’¡ Valaistus', 'light']
      ];
      topbar.innerHTML = data.map(([label, key]) => {
        const v = state.resources[key];
        const perS = state.rates[key];
        return `<div class="res"><b>${label}:</b> ${fmt(v)} <span class="small">(+${fmt(perS)}/s)</span><div class="bar"><div class="fill" style="width:${Math.min(100, (v % 120) / 1.2)}%"></div></div></div>`;
      }).join('');
    }

    function renderCards() {
      const term = document.getElementById('search').value.toLowerCase();
      const tier = document.getElementById('tier').value;
      const list = state.tab === 'TehtÃ¤vÃ¤t' ? [] : buildings.filter(b =>
        b.category === state.tab && b.name.toLowerCase().includes(term) && (tier === 'all' || String(b.tier) === tier)
      );
      cards.innerHTML = list.map(b => {
        const own = state.built[b.id] || { count: 0, level: 1 };
        const nextStar = Math.floor(b.cost.stars * Math.pow(1.13, own.count));
        const nextBerry = Math.floor(b.cost.berries * Math.pow(1.13, own.count));
        return `<div class="card">
          <div class="row"><b>${b.icon} ${b.name}</b><span>Tier ${b.tier}</span></div>
          <div class="small">Palikat: <span class="modules">${b.modules.join('')}</span></div>
          <div>${b.what}</div>
          <div class="small">What does it do? ${b.what}</div>
          <div class="small">Omistat: ${own.count} â€¢ Level ${own.level}</div>
          <div class="row" style="margin-top:6px;">
            <button onclick="buy('${b.id}',1)">Rakenna</button>
            <button onclick="buy('${b.id}',5)">Rakenna +5</button>
            <button onclick="upgrade('${b.id}',1)">Upgrade +1</button>
            <button onclick="upgrade('${b.id}',5)">Upgrade +5</button>
          </div>
          <div class="small">Hinta: âœ¨${nextStar} + ğŸ“${nextBerry}</div>
        </div>`;
      }).join('');
      if (state.tab === 'TehtÃ¤vÃ¤t') cards.innerHTML = '<div class="card">Valitse tehtÃ¤vÃ¤ oikealta paneelista ğŸ˜Š</div>';
    }

    function renderStats() {
      const totalBuild = Object.values(state.built).reduce((a, b) => a + b.count, 0);
      const joy = Math.min(100, (state.resources.fruits + state.resources.flowers + totalBuild * 2) / 4);
      const items = [
        ['ğŸ“ Marjat tuotanto/s', state.rates.berries],
        ['âœ¨ TÃ¤hdet tuotanto/min', state.rates.stars * 60],
        ['ğŸŒ¼ Kukat tuotanto/s', state.rates.flowers],
        ['ğŸ’¡ Valo tuotanto/s', state.rates.light],
        ['ğŸ HedelmÃ¤t tuotanto/s', state.rates.fruits],
        ['ğŸ˜Š Iloindeksi', joy]
      ];
      stats.innerHTML = items.map(([t, v]) => `<div style="margin-bottom:8px;"><b>${t}:</b> ${fmt(v)}<div class="bar"><div class="fill" style="width:${Math.min(100, v)}%"></div></div></div>`).join('');
    }

    function renderQuests() {
      questsEl.innerHTML = questDefs.map(q => {
        const done = !!state.questsDone[q.id];
        const ok = q.ok(state);
        return `<div class="quest"><b>${done ? 'âœ…' : 'ğŸŸ£'} ${q.txt}</b><div class="small">Haluatko tehdÃ¤ tehtÃ¤vÃ¤n?</div><button ${done || !ok ? 'disabled' : ''} onclick="claimQuest('${q.id}')">${done ? 'Valmis' : 'Lunasta palkinto'}</button></div>`;
      }).join('');
    }

    function renderShop() {
      shop.innerHTML = bonusShop.map(b => `<div class="shopItem"><b>${b.name}</b><div>${b.txt}</div><div class="small">Hinta: âœ¨${b.cost.stars} + ğŸ“${b.cost.berries} â€¢ Taso ${state.bonus[b.id]}</div><button onclick="buyBonus('${b.id}')">Osta</button></div>`).join('');
    }

    function renderTabs() {
      tabs.innerHTML = categories.map(c => `<button class="${state.tab === c ? 'active' : ''}" onclick="state.tab='${c}';render();">${c}</button>`).join('');
    }

    function render() {
      renderTop();
      renderTabs();
      renderCards();
      renderStats();
      renderQuests();
      renderShop();
    }

    let last = performance.now();
    function loop(t) {
      const dt = Math.min(0.05, (t - last) / 1000);
      last = t;
      update(dt);
      drawPark(dt);
      requestAnimationFrame(loop);
    }

    document.getElementById('search').addEventListener('input', renderCards);
    document.getElementById('tier').addEventListener('change', renderCards);
    document.getElementById('soundBtn').addEventListener('click', () => {
      state.soundOn = !state.soundOn;
      document.getElementById('soundBtn').textContent = state.soundOn ? 'ğŸ”Š Ã„Ã¤net: ON' : 'ğŸ”ˆ Ã„Ã¤net: OFF';
    });

    document.getElementById('saveBtn').addEventListener('click', () => {
      localStorage.setItem('bunDigiSave', JSON.stringify(state));
      showToast('Tallennettu! ğŸ’¾');
    });
    document.getElementById('loadBtn').addEventListener('click', () => {
      const raw = localStorage.getItem('bunDigiSave');
      if (!raw) return showToast('Ei tallennusta vielÃ¤');
      const loaded = JSON.parse(raw);
      Object.assign(state, loaded);
      calcRates();
      render();
      showToast('Ladattu! ğŸŒŸ');
    });
    document.getElementById('resetBtn').addEventListener('click', () => location.reload());

    render();
    calcRates();
    requestAnimationFrame(loop);

    // expose for inline buttons
    window.buy = buy;
    window.upgrade = upgrade;
    window.claimQuest = claimQuest;
    window.buyBonus = buyBonus;
  </script>
</body>
</html>
